<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-pending { color: #FFC107; font-weight: bold; }
        .status-preparing { color: #FD7E14; font-weight: bold; }
        .status-ready { color: #17A2B8; font-weight: bold; }
        .status-completed { color: #28A745; font-weight: bold; }
        .status-cancelled { color: #DC3545; font-weight: bold; }
        .modal-content { padding: 20px; }
        .action-buttons { white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Order Management System</h1>
        
        <!-- Search Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchOrderById" class="form-control" placeholder="Search by Order ID">
                    <button class="btn btn-primary" onclick="searchOrderById()">Search</button>
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchOrderByName" class="form-control" placeholder="Search by Customer Name">
                    <button class="btn btn-primary" onclick="searchOrderByName()">Search</button>
                </div>
            </div>
        </div>
        
        <!-- Add Order Button -->
        <button class="btn btn-success mb-3" onclick="openAddModal()">Add New Order</button>
        
        <!-- Orders Table -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Order ID</th>
                        <th>Customer Name</th>
                        <th>Order Date</th>
                        <th>Status</th>
                        <th>Quantity</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <!-- Orders will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Order Modal -->
    <div class="modal fade" id="addOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addOrderForm">
                        <div class="mb-3">
                            <label for="orderCustomerName" class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="orderCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="orderDate" class="form-label">Order Date *</label>
                            <input type="date" class="form-control" id="orderDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="orderStatus" class="form-label">Status *</label>
                            <select class="form-control" id="orderStatus" required>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="orderQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="orderQuantity" min="1" value="1" required>
                        </div>
                      
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addOrder()">Add Order</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Update Order Modal -->
    <div class="modal fade" id="updateOrderModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="updateOrderForm">
                        <input type="hidden" id="updateOrderId">
                        <div class="mb-3">
                            <label for="updateCustomerName" class="form-label">Customer Name *</label>
                            <input type="text" class="form-control" id="updateCustomerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateOrderDate" class="form-label">Order Date *</label>
                            <input type="date" class="form-control" id="updateOrderDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="updateOrderStatus" class="form-label">Status *</label>
                            <select class="form-control" id="updateOrderStatus" required>
                                <option value="pending">Pending</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="updateQuantity" class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="updateQuantity" min="1" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateOrderDetails()">Update Order</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let burgers = [];
        let currentOrderId = null;
        const addModal = new bootstrap.Modal('#addOrderModal');
        const updateModal = new bootstrap.Modal('#updateOrderModal');

        // Initialize when page loads
        document.addEventListener("DOMContentLoaded", function() {
            loadOrders();
            loadBurgers();
        });

        // Load all orders
        function loadOrders() {
            fetch("http://localhost:8080/orders/allOrder")
                .then(res => {
                    if (!res.ok) throw new Error('Network response was not ok');
                    return res.json();
                })
                .then(data => displayOrders(data))
                .catch(error => {
                    console.error("Error fetching orders:", error);
                    alert("Failed to load orders. Please try again.");
                });
        }

        // Display orders in table
        function displayOrders(orders) {
            const tableBody = document.getElementById("orderTableBody");
            tableBody.innerHTML = "";

            if (!orders || orders.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="7" class="text-center">No orders found</td></tr>`;
                return;
            }

            // Convert single order to array for consistency
            if (!Array.isArray(orders)) {
                orders = [orders];
            }

            orders.forEach(order => {
                const burger = burgers.find(b => b.id == order.burger_id) || { name: `Burger ID: ${order.burger_id}` };
                const row = document.createElement("tr");
                
                row.innerHTML = `
                    <td>${order.order_id}</td>
                    <td>${order.c_name}</td>
                    <td>${new Date(order.order_date).toLocaleDateString()}</td>
                    <td class="status-${order.order_status}">${capitalizeFirstLetter(order.order_status)}</td>
                    <td>${order.quantity}</td>
                    <td class="action-buttons">
                        <button class="btn btn-warning btn-sm me-2" onclick="openEditModal(${order.order_id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteOrder(${order.order_id})">Delete</button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Load available burgers
        function loadBurgers() {
            fetch("/api/burgers")
                .then(res => {
                    if (!res.ok) throw new Error('Failed to load burgers');
                    return res.json();
                })
                .then(data => {
                    burgers = data;
                    populateBurgerDropdowns();
                })
                .catch(error => {
                    console.error("Error loading burgers:", error);
                    alert("Failed to load burger options. Please refresh the page.");
                });
        }

        // Populate burger dropdowns in both modals
        function populateBurgerDropdowns() {
            const addDropdown = document.getElementById("orderBurgerId");
            const updateDropdown = document.getElementById("updateBurgerId");
            
            // Clear existing options
            addDropdown.innerHTML = '';
            updateDropdown.innerHTML = '';
            
            // Add default option
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.textContent = "-- Select a Burger --";
            defaultOption.disabled = true;
            defaultOption.selected = true;
            
            addDropdown.appendChild(defaultOption.cloneNode(true));
            updateDropdown.appendChild(defaultOption.cloneNode(true));
            
            // Add burger options
            burgers.forEach(burger => {
                const option = document.createElement("option");
                option.value = burger.id;
                option.textContent = `${burger.name} ($${burger.price})`;
                
                addDropdown.appendChild(option.cloneNode(true));
                updateDropdown.appendChild(option.cloneNode(true));
            });
        }

        // Open Add Order Modal
        function openAddModal() {
            document.getElementById("addOrderForm").reset();
            document.getElementById("orderDate").valueAsDate = new Date();
            addModal.show();
        }

        // Add new order
        function addOrder() {
            const c_name = document.getElementById("orderCustomerName").value.trim();
            const order_date = document.getElementById("orderDate").value;
            const order_status = document.getElementById("orderStatus").value;
            const quantity = document.getElementById("orderQuantity").value;

            // Validate inputs
            if (!c_name || !order_date || !quantity || !burger_id) {
                alert("Please fill all required fields");
                return;
            }

            fetch("http://localhost:8080/orders/addOrder", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ burger_id, c_name, order_date, order_status, quantity })
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to add order');
                return res.json();
            })
            .then(() => {
                addModal.hide();
                loadOrders();
                alert("Order added successfully!");
            })
            .catch(error => {
                console.error("Error adding order:", error);
                alert("Failed to add order. Please try again.");
            });
        }

        // Open Edit Order Modal
        function openEditModal(order_id) {
            fetch(`http://localhost:8080/orders/search-by-order-id/${order_id}`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to load order details');
                    return res.json();
                })
                .then(order => {
                    if (!order) {
                        alert("Order not found");
                        return;
                    }

                    currentOrderId = order.order_id;
                    document.getElementById("updateOrderId").value = order.order_id;
                    document.getElementById("updateCustomerName").value = order.c_name;
                    document.getElementById("updateOrderDate").value = order.order_date.split('T')[0];
                    document.getElementById("updateOrderStatus").value = order.order_status;
                    document.getElementById("updateQuantity").value = order.quantity;
                    
                    updateModal.show();
                })
                .catch(error => {
                    console.error("Error loading order details:", error);
                    alert("Failed to load order details. Please try again.");
                });
        }

        // Update order details
        function updateOrderDetails() {
            const c_name = document.getElementById("updateCustomerName").value.trim();
            const order_date = document.getElementById("updateOrderDate").value;
            const order_status = document.getElementById("updateOrderStatus").value;
            const quantity = document.getElementById("updateQuantity").value;

            // Validate inputs
            if (!c_name || !order_date || !quantity || !burger_id) {
                alert("Please fill all required fields");
                return;
            }

            fetch("http://localhost:8080/orders/updateOrder", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    order_id: currentOrderId, 
                    c_name, 
                    order_date, 
                    order_status, 
                    quantity 
                })
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to update order');
                return res.json();
            })
            .then(() => {
                updateModal.hide();
                loadOrders();
                alert("Order updated successfully!");
            })
            .catch(error => {
                console.error("Error updating order:", error);
                alert("Failed to update order. Please try again.");
            });
        }

        // Delete order
        function deleteOrder(order_id) {
            if (!confirm("Are you sure you want to delete this order?")) return;

            fetch(`http://localhost:8080/orders/delete/${order_id}`, { 
                method: "DELETE" 
            })
            .then(res => {
                if (!res.ok) throw new Error('Failed to delete order');
                return res.json();
            })
            .then(() => {
                loadOrders();
                alert("Order deleted successfully!");
            })
            .catch(error => {
                console.error("Error deleting order:", error);
                alert("Failed to delete order. Please try again.");
            });
        }

        // Search by order ID
        function searchOrderById() {
            const order_id = document.getElementById("searchOrderById").value.trim();
            
            if (!order_id) {
                loadOrders();
                return;
            }

            fetch(`http://localhost:8080/orders/search-by-order-id/${order_id}`)
                .then(res => {
                    if (!res.ok) throw new Error('Order not found');
                    return res.json();
                })
                .then(data => displayOrders(data))
                .catch(error => {
                    console.error("Error searching order by ID:", error);
                    document.getElementById("orderTableBody").innerHTML = 
                        `<tr><td colspan="7" class="text-center">No order found with ID: ${order_id}</td></tr>`;
                });
        }

        // Search by customer name
        function searchOrderByName() {
            const name = document.getElementById("searchOrderByName").value.trim();
            
            if (!name) {
                loadOrders();
                return;
            }

            fetch(`http://localhost:8080/orders/search-by-order-name/${encodeURIComponent(name)}`)
                .then(res => {
                    if (!res.ok) throw new Error('No orders found');
                    return res.json();
                })
                .then(data => displayOrders(data))
                .catch(error => {
                    console.error("Error searching orders by name:", error);
                    document.getElementById("orderTableBody").innerHTML = 
                        `<tr><td colspan="7" class="text-center">No orders found for customer: ${name}</td></tr>`;
                });
        }

        // Helper function to capitalize first letter
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
    </script>
</body>
</html>